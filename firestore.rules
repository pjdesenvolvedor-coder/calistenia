rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset establishes a public-facing quiz system with a
     * protected administrative backend. The primary goal is to allow any user,
     * including anonymous ones, to take quizzes and generate analytics data (clicks, attempts),
     * while strictly limiting content management and data viewership to designated administrators.
     *
     * Data Structure: Quiz content (/quizzes), products (/products), and user-generated
     * data (/quiz_attempts, /quiz_clicks) are organized in separate top-level collections.
     * A dedicated /roles_admin collection is used to define administrator privileges,
     * which is a highly performant pattern for role-based access control.
     *
     * Key Security Decisions:
     * - Admin Role: Administrator status is determined by the existence of a document
     *   in the `/roles_admin/{userId}` collection. This avoids storing roles on user
     *   documents and works seamlessly with authenticated and anonymous users.
     * - Public Quiz Funnel: Quizzes and products are publicly readable. Anyone can
     *   create quiz attempts and click events to support the user funnel without requiring login.
     * - Write-Once Data: User-generated data like quiz attempts is "write-once". Users
     *   can submit their data, but cannot read, update, or delete it afterwards, enhancing privacy
     *   and data integrity.
     * - Segregated Analytics: Quiz click data is stored in a separate `/quiz_clicks`
     *   collection. While anyone can create documents here, only admins can read or list them,
     *   structurally separating public actions from private analysis.
     *
     * Denormalization for Authorization: The existence of a document in `/roles_admin/{userId}`
     * serves as the sole source of truth for admin privileges. This is checked with a simple
     * and fast `exists()` call, eliminating the need for complex joins or lookups.
     *
     * Structural Segregation: The separation of public content (`/quizzes`) from private
     * analytics (`/quiz_clicks`) is a core design choice. This allows for simple,
     * collection-wide rules that are highly secure and performant, preventing accidental
     * data leakage.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if the requesting user is a designated administrator by verifying
     * the existence of a corresponding document in the roles_admin collection.
     */
    function isAdmin() {
      // Must be signed in AND have a role document.
      return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * For update/delete operations on admin-controlled resources. Ensures the user is
     * an admin AND the document they are trying to modify already exists.
     */
    function isExistingDocAdmin() {
      return isAdmin() && resource != null;
    }

    /**
     * On creation of a question, validates that the 'quizId' field in the new
     * document's data matches the quizId from the path.
     */
    function hasValidQuestionParent(quizId) {
      return request.resource.data.quizId == quizId;
    }

    /**
     * On creation of an answer, validates that the 'questionId' field in the new
     * document's data matches the questionId from the path.
     */
    function hasValidAnswerParent(questionId) {
      return request.resource.data.questionId == questionId;
    }


    /**
     * @description Defines rules for the quizzes collection. Quizzes are public to read
     *              but can only be created, modified, or deleted by administrators.
     * @path        /quizzes/{quizId}
     * @allow       (get) Any user, signed-in or anonymous, can read a quiz.
     * @allow       (create) An admin can create a new quiz.
     * @deny        (create) An anonymous or non-admin user cannot create a quiz.
     * @deny        (update) A non-admin user cannot modify an existing quiz.
     * @principle   Public read with role-based writes.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isExistingDocAdmin();

      /**
       * @description Defines rules for the questions subcollection. Questions inherit the
       *              read permissions of their parent quiz and write permissions are
       *              restricted to administrators.
       * @path        /quizzes/{quizId}/questions/{questionId}
       * @allow       (get) Any user can read a question.
       * @allow       (create) An admin can create a new question for a quiz.
       * @deny        (create) A non-admin user cannot create a question.
       * @deny        (create) An admin cannot create a question with a mismatched quizId.
       * @principle   Inherited access with relational integrity validation.
       */
      match /questions/{questionId} {
        allow get, list: if true;
        allow create: if isAdmin() && hasValidQuestionParent(quizId);
        allow update, delete: if isExistingDocAdmin();

        /**
         * @description Defines rules for the answers subcollection. Answers are public
         *              to read, but writes are restricted to administrators.
         * @path        /quizzes/{quizId}/questions/{questionId}/answers/{answerId}
         * @allow       (get) Any user can read an answer.
         * @allow       (create) An admin can create a new answer for a question.
         * @deny        (create) A non-admin user cannot create an answer.
         * @deny        (update) A non-admin user cannot modify an answer.
         * @principle   Inherited access with relational integrity validation.
         */
        match /answers/{answerId} {
          allow get, list: if true;
          allow create: if isAdmin() && hasValidAnswerParent(questionId);
          allow update, delete: if isExistingDocAdmin();
        }
      }
    }

    /**
     * @description Defines rules for quiz attempts. This is a write-only collection
     *              for any user to submit their quiz results. No one can read, update,
     *              or delete attempts from the client.
     * @path        /quiz_attempts/{quizAttemptId}
     * @allow       (create) Any user, signed-in or anonymous, can create a quiz attempt.
     * @deny        (get) No user can read another user's quiz attempt.
     * @deny        (list) No user can list all quiz attempts.
     * @deny        (update) No user can modify an attempt after it's created.
     * @principle   Public append-only log for anonymous data submission.
     */
    match /quiz_attempts/{quizAttemptId} {
      allow get: if false;
      allow list: if false;
      allow create: if true;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Defines rules for answered questions within an attempt. Follows the
       *              same write-only pattern as its parent document.
       * @path        /quiz_attempts/{quizAttemptId}/answered_questions/{answeredQuestionId}
       * @allow       (create) Any user can create an answered question record as part of an attempt.
       * @deny        (get) No user can read individual answered questions.
       * @principle   Public append-only log for anonymous data submission.
       */
      match /answered_questions/{answeredQuestionId} {
        allow get: if false;
        allow list: if false;
        allow create: if true;
        allow update: if false;
        allow delete: if false;
      }
    }

    /**
     * @description Defines rules for product recommendations. This is a write-only collection
     *              for any user to submit data. No one can read, update,
     *              or delete recommendations from the client.
     * @path        /product_recommendations/{productRecommendationId}
     * @allow       (create) Any user can create a product recommendation document.
     * @deny        (get) No user can read recommendation documents.
     * @principle   Public append-only log for anonymous data submission.
     */
    match /product_recommendations/{productRecommendationId} {
      allow get: if false;
      allow list: if false;
      allow create: if true;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Defines rules for the products collection. Products are public to read
     *              but can only be managed by administrators.
     * @path        /products/{productId}
     * @allow       (list) Any user, signed-in or anonymous, can list all products.
     * @allow       (create) An admin can create a new product.
     * @deny        (create) A regular user cannot create a product.
     * @deny        (delete) A regular user cannot delete a product.
     * @principle   Public read with role-based writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isExistingDocAdmin();
    }

    /**
     * @description Defines rules for quiz click analytics. Any user can create a click
     *              event, but only administrators can read, list, or manage this data.
     * @path        /quiz_clicks/{quizClickId}
     * @allow       (create) Any user, signed-in or anonymous, can generate a click event.
     * @allow       (list, get) An admin can list all click events for analysis.
     * @deny        (get) A non-admin user cannot read a specific click event document.
     * @deny        (list) A non-admin user cannot list the collection.
     * @principle   Segregates public write actions from private read/analysis actions.
     */
    match /quiz_clicks/{quizClickId} {
      allow get, list: if isAdmin();
      allow create: if true;
      allow update, delete: if isExistingDocAdmin();
    }

    /**
     * @description Defines admin roles. The existence of a document grants admin
     *              privileges. Only admins can see who other admins are.
     *              No one can change roles from the client-side for security.
     * @path        /roles_admin/{userId}
     * @allow       (get) An admin can check if another user is an admin.
     * @deny        (create) No user can grant admin privileges from the client.
     * @deny        (delete) No user can revoke admin privileges from the client.
     * @principle   Secure, server-side management of roles. Client is read-only for admins.
     */
    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
